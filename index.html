<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Time-Varying Phillips Curves</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    :root { --card-bg:#111320; --card-bg-soft:#15182a; --accent:#31e1ff; --text-main:#f5f5f7; --text-subtle:#9ca3af; --border-subtle:#25273a; }
    * { box-sizing:border-box; }
    html,body { height:100%; margin:0; padding:0; }
    body { min-height:100vh; background:radial-gradient(circle at top,#15192b 0,#05060a 55%); color:var(--text-main); font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",sans-serif; font-size:16px; -webkit-text-size-adjust:none; text-size-adjust:none; overflow:auto; }
    body::before { content:''; position:fixed; inset:0; z-index:0; }
    .stage { min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px 20px; position:relative; z-index:1; }
    #landing-stage { min-width:860px; }
    #app-stage { width:1120px; min-width:1120px; min-height:100vh; align-items:stretch; justify-content:center; margin:0 auto; }
    .main-shell { width:820px; flex-shrink:0; transform:scale(1.05); transform-origin:center center; position:relative; }
    .card { background:linear-gradient(135deg,var(--card-bg) 0%,var(--card-bg-soft) 100%); border-radius:16px; border:1px solid var(--border-subtle); box-shadow:0 18px 40px rgba(0,0,0,0.6); padding:24px 28px; backdrop-filter:blur(14px); cursor:default; }
    #landing { max-width:820px; margin:0 auto; background:radial-gradient(circle at right,rgba(49,225,255,0.08),transparent 60%),linear-gradient(135deg,var(--card-bg) 0%,var(--card-bg-soft) 100%); }
    #app { background:linear-gradient(135deg,var(--card-bg) 0%,var(--card-bg-soft) 100%); width:1120px; min-width:1120px; flex-shrink:0; }
    #app-footer { width:1120px; min-width:1120px; flex-shrink:0; }
    h1,h2 { margin:0; font-weight:600; letter-spacing:0.02em; }
    h1 { font-size:1.8rem; } h2 { font-size:1.5rem; white-space:nowrap; }
    p { margin:8px 0; color:var(--text-subtle); line-height:1.5; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:4px 12px; border-radius:999px; background:rgba(49,225,255,0.09); border:1px solid rgba(49,225,255,0.18); font-size:0.75rem; text-transform:uppercase; letter-spacing:0.12em; color:var(--accent); white-space:nowrap; flex-shrink:0; }
    .pill-dot { width:8px; height:8px; border-radius:50%; background:var(--accent); box-shadow:0 0 10px var(--accent); flex-shrink:0; }
    .controls-row { display:flex; flex-wrap:wrap; gap:16px 18px; margin-top:24px; align-items:flex-end; }
    .app-controls-row { margin-top:32px; flex-wrap:nowrap; justify-content:space-between; }
    .app-controls-row .control-group { flex:1 1 0; }
    .app-controls-row .control-group select { width:100%; }
    .control-group { display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
    .control-label { font-size:0.8rem; color:var(--text-subtle); margin-left:5px; }
    .control-group select { width:220px; }
    select { padding:8px 10px; font-size:0.9rem; border-radius:10px; border:1px solid var(--border-subtle); background:#050712; color:var(--text-main); outline:none; appearance:none; -webkit-appearance:none; cursor:pointer; transition:border-color 0.2s ease,box-shadow 0.2s ease,background 0.2s ease,transform 0.05s ease; }
    select:hover { border-color:var(--accent); box-shadow:0 0 0 1px rgba(49,225,255,0.35); background:#070918; }
    button { padding:8px 14px; font-size:0.9rem; border-radius:10px; border:1px solid var(--border-subtle); background:#050712; color:var(--text-main); outline:none; cursor:pointer; transition:border-color 0.2s ease,box-shadow 0.2s ease,background 0.2s ease,transform 0.05s ease; white-space:nowrap; height:36px; }
    button:hover { border-color:var(--accent); box-shadow:0 0 0 1px rgba(49,225,255,0.35); background:#070918; transform:translateY(-1px); }
    button:active { transform:translateY(1px); box-shadow:0 0 0 1px rgba(49,225,255,0.2); }
    .primary-btn { background:radial-gradient(circle at 0 0,rgba(49,225,255,0.28),transparent 55%),linear-gradient(135deg,#0d90b8,#31e1ff); border:none; color:#05060a; font-weight:600; box-shadow:0 4px 10px rgba(0,0,0,0.3); height:auto; padding:8px 32px; border-radius:10px; will-change:transform; isolation:isolate; }
    .primary-btn:hover { box-shadow:0 12px 28px rgba(0,0,0,0.75); transform:translateY(-1px); border:none; background:radial-gradient(circle at 0 0,rgba(49,225,255,0.35),transparent 55%),linear-gradient(135deg,#10a4cf,#4ae5ff); }
    .primary-btn:active { transform:translateY(1px); box-shadow:0 4px 14px rgba(0,0,0,0.7); }
    .landing-region-group { flex-direction:row; align-items:center; gap:10px; }
    .landing-region-group .control-label { margin:0; }
    #landing .controls-row { align-items:center; justify-content:space-between; }
    .pill-button { display:inline-flex; align-items:center; justify-content:center; gap:6px; padding:4px 10px; border-radius:999px; background:rgba(49,225,255,0.09); border:1px solid rgba(49,225,255,0.18); font-size:0.75rem; text-transform:uppercase; letter-spacing:0.12em; color:var(--accent); height:auto; box-shadow:none; width:80px; flex-shrink:0; }
    .pill-button:hover { background:rgba(49,225,255,0.14); border-color:rgba(49,225,255,0.28); color:var(--accent); transform:none; box-shadow:0 0 12px rgba(49,225,255,0.25); }
    #landing,#app { display:none; animation:fadeIn 0.4s ease-out; }
    #landing.active,#app.active { display:block; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
    @keyframes revealLine { 0%{width:0} 100%{width:100%} }
    @keyframes fadeInNote { 0%{opacity:0;transform:translateY(3px)} 100%{opacity:1;transform:translateY(0)} }
    .footer-line-animate { width:0; overflow:hidden; animation:revealLine 0.9s cubic-bezier(0.4,0,0.2,1) forwards; }
    .footer-text-animate { opacity:0; animation:fadeInNote 0.5s ease-out 0.7s forwards; }
    .app-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; gap:12px; flex-wrap:nowrap; min-width:0; }
    .app-header-right { display:flex; flex-direction:row; align-items:center; gap:10px; flex-shrink:0; }
    .plot-shell { margin-top:18px; display:flex; gap:18px; align-items:stretch; }
    #plot { flex:1 1 auto; min-height:520px; min-width:880px; width:880px; border-radius:14px; background:#050712; padding:6px 18px 6px 6px; overflow:hidden; }
    .slider-shell { width:110px; flex-shrink:0; display:flex; flex-direction:column; align-items:center; }
    .slider-column { width:100%; flex:1 1 auto; border-radius:14px; background:radial-gradient(circle at bottom,rgba(49,225,255,0.1),transparent 55%); border:1px solid var(--border-subtle); padding:12px 4px 12px; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .slider-wrapper { width:100%; flex:1 1 auto; display:flex; align-items:center; justify-content:center; min-height:0; position:relative; }
    #bandwidthSlider { -webkit-appearance:none; appearance:none; width:200px; height:18px; background:transparent; outline:none; transform:rotate(-90deg); cursor:pointer; position:absolute; flex-shrink:0; opacity:0; transition:opacity 0.2s ease; }
    #bandwidthSlider::-webkit-slider-thumb { -webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%; background:var(--accent); box-shadow:0 0 12px rgba(49,225,255,0.8); border:1px solid #02141b; margin-top:-5.5px; }
    #bandwidthSlider::-moz-range-thumb { width:18px; height:18px; border-radius:50%; background:var(--accent); border:none; }
    #bandwidthSlider::-webkit-slider-runnable-track { border-radius:999px; background:#050712; height:7px; }
    #bandwidthSlider::-moz-range-track { border-radius:999px; background:#050712; height:7px; }
    .slider-value-pill { font-size:0.75rem; font-variant-numeric:tabular-nums; padding:10px 6px; border-radius:8px; background:rgba(49,225,255,0.08); border:1px solid rgba(49,225,255,0.2); color:var(--accent); box-shadow:none; width:76px; text-align:center; flex-shrink:0; margin-top:6px; }
    .map-shell { margin-top:20px; width:100%; border-radius:12px; border:1px solid var(--border-subtle); background:rgba(5,7,18,0.6); overflow:hidden; isolation:isolate; transform:translateZ(0); }
    #regionMap { width:100%; height:430px; display:block; }
    #regionMap .country { fill:none; stroke:#4a4e6a; stroke-width:1.0; stroke-linejoin:round; transition:fill 0.3s ease,stroke 0.3s ease; }
    #regionMap .country.highlighted { fill:rgba(49,225,255,0.15); stroke:var(--accent); stroke-width:0.8; filter:drop-shadow(0 0 4px rgba(49,225,255,0.5)); }
    #regionMap .country.hoverable { cursor:pointer; }
    #regionMap .country.hoverable:hover { fill:rgba(49,225,255,0.08); stroke:rgba(49,225,255,0.5); }
    #map-tooltip { position:absolute; background:var(--card-bg); border:1px solid var(--border-subtle); color:var(--text-subtle); font-size:0.7rem; padding:4px 8px; border-radius:6px; pointer-events:none; opacity:0; transition:opacity 0.15s ease; white-space:nowrap; }
    .landing-credit-inner { display:inline-block; }
    #plot .hoverlayer { transform:translateX(1.5px); }
  </style>
</head>
<body onclick="handleBgClick(event)">

  <div id="landing-stage" class="stage">
    <div class="main-shell">
      <div id="landing" class="card active">
        <h1>Time-Varying Phillips Curves</h1>
        <p>Browse kernel-based estimates of the Phillips curve over time.</p>
        <div class="controls-row" style="justify-content:space-between;align-items:center;">
          <div class="control-group landing-region-group">
            <label for="regionSelector" class="control-label">Region:</label>
            <select id="regionSelector" onchange="onRegionChange(this.value)">
              <option value="europe">Europe</option>
              <option value="north-america">North America</option>
            </select>
          </div>
          <div class="control-group landing-region-group" style="margin-left:-60px;">
            <label for="countrySelector" class="control-label">Country:</label>
            <select id="countrySelector" onchange="onCountryChange(this.value)"></select>
          </div>
          <button type="button" class="primary-btn" style="padding:8px 18px;" onclick="startApp()">Enter</button>
        </div>
        <div class="map-shell" style="position:relative;">
          <div id="map-tooltip"></div>
          <svg id="regionMap"></svg>
        </div>
      </div>
      <div id="landing-credit" style="width:820px;margin:18px auto 0;">
        <div class="landing-credit-inner">
          <div id="landing-line" class="footer-line-animate" style="height:1px;background:rgba(255,255,255,0.375);margin:0 0 13px 0;width:100%;"></div>
          <p id="landing-text" class="footer-text-animate" style="margin:0;font-size:0.71rem;color:rgba(255,255,255,0.50);letter-spacing:0.06em;white-space:nowrap;">Developed by Omar Kaykhusraw.</p>
        </div>
      </div>
    </div>
  </div>

  <div id="app-stage" class="stage" style="display:none;">
    <div id="app" class="card">
      <div class="app-header">
        <h2>Time-Varying Parameters of the Phillips Curve</h2>
        <div class="app-header-right">
          <div class="pill"><span class="pill-dot"></span><span id="appPillText">Europe &middot; Austria</span></div>
          <button type="button" class="pill-button" onclick="goBack()">&#8592; Back</button>
        </div>
      </div>
      <div class="controls-row app-controls-row">
        <div class="control-group"><label class="control-label" for="pcType">Specification:</label><select id="pcType"></select></div>
        <div class="control-group"><label class="control-label" for="estimator">Estimator:</label><select id="estimator"></select></div>
        <div class="control-group"><label class="control-label" for="kernel">Kernel:</label><select id="kernel"></select></div>
        <div class="control-group"><label class="control-label" for="coef">Coefficient:</label><select id="coef"></select></div>
      </div>
      <div class="plot-shell">
        <div id="plot"></div>
        <div class="slider-shell">
          <div class="slider-column">
            <div class="slider-value-pill" id="bandwidthLabel">h = 0.5</div>
            <div class="slider-wrapper">
              <input type="range" id="bandwidthSlider" min="0" max="0" step="1" value="0">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="app-footer" style="display:none;margin-top:20px;">
      <div>
        <hr id="app-footer-hr" class="footer-line-animate" style="border:none;border-top:1px solid rgba(255,255,255,0.375);margin:0 0 18px 0;">
        <p id="app-footer-text" class="footer-text-animate" style="margin:0 0 4px 0;font-size:0.71rem;color:rgba(255,255,255,0.50);line-height:1.8;text-align:justify;">
          <b>Note</b>: Estimates generated using
          <a href="https://doi.org/10.1016/j.jeconom.2013.10.009" target="_blank" style="color:rgba(255,255,255,0.50);text-decoration:none;">Giraitis, L., Kapetanios, G. and Yates, T. (2014) 'Inference on stochastic time-varying coefficient models', <em>Journal of Econometrics</em>, 179(1), pp.46-65</a>;
          <a href="https://doi.org/10.1111/jtsa.12271" target="_blank" style="color:rgba(255,255,255,0.50);text-decoration:none;">Giraitis, L., Kapetanios, G. and Yates, T. (2018) 'Inference on multivariate heteroscedastic time varying random coefficient models', <em>Journal of Time Series Analysis</em>, 39(2), pp.129-149</a>; and
          <a href="https://doi.org/10.1016/j.jeconom.2020.08.013" target="_blank" style="color:rgba(255,255,255,0.50);text-decoration:none;">Giraitis, L., Kapetanios, G. and Marcellino, M. (2021) 'Time-varying instrumental variable estimation', <em>Journal of Econometrics</em>, 224(2), pp.394-415</a>.
          For further details or data provisions, please contact the developer at
          <a href="/cdn-cgi/l/email-protection#3f50525e4d11545e4654574a4c4d5e487f58525e5653115c5052" style="color:rgba(255,255,255,0.50);text-decoration:none;"><span class="__cf_email__" data-cfemail="ee81838f9cc0858f9785869b9d9c8f99ae89838f8782c08d8183">[email&#160;protected]</span></a>.
        </p>
      </div>
    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    function handleBgClick(e) {}

    var REGION_MAP_CODES = {
      "europe":        ["AUT","BEL","BUL","CRO","CYP","EST","FIN","FRA","DEU","GRC","IRL","ITA","LVA","LTU","LUX","MLT","NLD","PRT","SVK","SVN","ESP","GBR"],
      "north-america": ["USA"]
    };

    var REGION_LABELS = { "europe":"Europe", "north-america":"North America" };
    var REGION_DEFAULT = { "europe":"AUT", "north-america":"USA" };

    var REGION_DROPDOWN = {
      "europe":        ["AUT","BEL","BUL","CRO","CYP","EST","FIN","FRA","DEU","GRC","IRL","ITA","LVA","LTU","LUX","MLT","NLD","PRT","SVK","SVN","ESP","GBR","EUR"],
      "north-america": ["USA"]
    };

    var ISO_NAMES = {
      "EUR":"Euro Area",
      "AUT":"Austria","BEL":"Belgium","BUL":"Bulgaria","CRO":"Croatia",
      "CYP":"Cyprus","EST":"Estonia","FIN":"Finland","FRA":"France",
      "DEU":"Germany","GRC":"Greece","IRL":"Ireland","ITA":"Italy",
      "LVA":"Latvia","LTU":"Lithuania","LUX":"Luxembourg","MLT":"Malta",
      "NLD":"Netherlands","PRT":"Portugal","SVK":"Slovakia","SVN":"Slovenia",
      "ESP":"Spain","GBR":"United Kingdom","USA":"United States"
    };

    var ISO_TO_FILE = {
      "EUR":"tvpc_eur",
      "AUT":"tvpc_aus","BEL":"tvpc_bel","BUL":"tvpc_bul","CRO":"tvpc_cro",
      "CYP":"tvpc_cyp","EST":"tvpc_est","FIN":"tvpc_fin","FRA":"tvpc_fra",
      "DEU":"tvpc_ger","GRC":"tvpc_gre","IRL":"tvpc_ire","ITA":"tvpc_ita",
      "LVA":"tvpc_lat","LTU":"tvpc_lit","LUX":"tvpc_lux","MLT":"tvpc_mal",
      "NLD":"tvpc_net","PRT":"tvpc_por","SVK":"tvpc_slk","SVN":"tvpc_sln",
      "ESP":"tvpc_spa","GBR":"tvpc_uk","USA":"tvpc_us"
    };

    function populateCountrySelector(region) {
      var sel = document.getElementById('countrySelector');
      sel.innerHTML = '';
      (REGION_DROPDOWN[region] || []).forEach(function(iso) {
        var o = document.createElement('option');
        o.value = iso; o.textContent = ISO_NAMES[iso] || iso;
        sel.appendChild(o);
      });
      sel.value = REGION_DEFAULT[region] || sel.options[0].value;
    }

    function onRegionChange(value) {
      populateCountrySelector(value);
      highlightCodes(REGION_MAP_CODES[value] || []);
    }

    function onCountryChange(value) {
      if (!value) { highlightCodes(REGION_MAP_CODES[document.getElementById('regionSelector').value] || []); }
      else if (value === 'EUR') { highlightCodes(REGION_MAP_CODES['europe']); }
      else { highlightCodes([value]); }
    }

    var mapReady = false;

    function highlightCodes(codes) {
      if (!mapReady) return;
      d3.selectAll('#regionMap .country').classed('highlighted', false);
      codes.forEach(function(c) { d3.select('#regionMap .country[data-iso="' + c + '"]').classed('highlighted', true); });
    }

    window.addEventListener('DOMContentLoaded', function() {
      var svgEl = document.getElementById('regionMap');
      var width = svgEl.clientWidth || 760;
      var height = 430;
      var tooltip = document.getElementById('map-tooltip');
      var projection = d3.geoMercator().scale(1).translate([0,0]);
      var path = d3.geoPath().projection(projection);

      fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
        .then(function(r) { return r.json(); })
        .then(function(world) {
          var countries = topojson.feature(world, world.objects.countries);
          var n2a = {
            "040":"AUT","056":"BEL","100":"BUL","191":"CRO","196":"CYP",
            "233":"EST","246":"FIN","250":"FRA","276":"DEU","300":"GRC",
            "372":"IRL","380":"ITA","428":"LVA","440":"LTU","442":"LUX",
            "470":"MLT","528":"NLD","620":"PRT","703":"SVK","705":"SVN",
            "724":"ESP","826":"GBR","840":"USA"
          };

          var filtered = {
            type:'FeatureCollection',
            features: countries.features.filter(function(d) { return String(d.id) !== '10'; }).map(function(d) {
              if (d.geometry && d.geometry.type === 'MultiPolygon') {
                var iso = n2a[String(d.id).padStart(3,'0')];
                var polys = d.geometry.coordinates.filter(function(poly) {
                  var ring = poly[0];
                  var avgLon = ring.reduce(function(s,p){return s+p[0];},0)/ring.length;
                  var avgLat = ring.reduce(function(s,p){return s+p[1];},0)/ring.length;
                  if (iso === 'FRA') return avgLon > -10 && avgLat > 40;
                  return avgLon > -170 && avgLat > -58 && avgLat < 84;
                });
                if (!polys.length) return null;
                return Object.assign({}, d, {geometry: Object.assign({}, d.geometry, {coordinates: polys})});
              }
              return d;
            }).filter(Boolean)
          };

          projection.fitSize([width, height], filtered);
          projection.scale(projection.scale() * 1.3);
          var tr = projection.translate(); projection.translate(tr);

          var svg = d3.select('#regionMap');
          svg.attr('viewBox','0 0 '+width+' '+height).attr('width',width).attr('height',height);

          svg.append('g').selectAll('.country').data(filtered.features).enter().append('path')
            .attr('class', function(d) {
              var iso = n2a[String(d.id).padStart(3,'0')] || '';
              return 'country' + (iso ? ' hoverable' : '');
            })
            .attr('d', function(d) { try { return path(d); } catch(e) { return ''; } })
            .attr('data-iso', function(d) {
              var iso = n2a[String(d.id).padStart(3,'0')] || '';
              if (iso === 'USA' && d.geometry && d.geometry.type === 'MultiPolygon') {
                var ring = d.geometry.coordinates[0][0];
                var avgLon = ring.reduce(function(s,p){return s+p[0];},0)/ring.length;
                if (avgLon < -130) return '';
              }
              return iso;
            })
            .on('mouseenter', function(event, d) {
              var iso = n2a[String(d.id).padStart(3,'0')];
              if (!iso) return;
              tooltip.textContent = ISO_NAMES[iso] || iso; tooltip.style.opacity = '1';
            })
            .on('mousemove', function(event) {
              var box = document.querySelector('.map-shell').getBoundingClientRect();
              tooltip.style.left = (event.clientX-box.left+10)+'px'; tooltip.style.top = (event.clientY-box.top-28)+'px';
            })
            .on('mouseleave', function() { tooltip.style.opacity = '0'; })
            .on('click', function(event, d) {
              var iso = n2a[String(d.id).padStart(3,'0')];
              if (!iso) return;
              document.getElementById('countrySelector').value = iso; highlightCodes([iso]);
            });

          mapReady = true;
          populateCountrySelector('europe');
          highlightCodes(['AUT']);
        }).catch(function() {});
    });

    function syncSliderLength() {
      var wrapper = document.querySelector('.slider-wrapper');
      var slider = document.getElementById('bandwidthSlider');
      if (!wrapper || !slider) return;
      var h = wrapper.clientHeight;
      if (h > 0) slider.style.width = Math.round(h * 0.88) + 'px';
    }
    window.addEventListener('resize', syncSliderLength);

    var fullData = [], h1Values = [], coefBySpec = {};

    function goBack() {
      document.getElementById('app-stage').style.display = 'none';
      document.getElementById('app-footer').style.display = 'none';
      document.getElementById('landing-stage').style.display = 'flex';
      document.getElementById('landing-credit').style.display = 'block';
      var ll = document.getElementById('landing-line'), lp = document.getElementById('landing-text');
      ll.classList.remove('footer-line-animate'); void ll.offsetWidth; ll.classList.add('footer-line-animate');
      lp.classList.remove('footer-text-animate'); void lp.offsetWidth; lp.classList.add('footer-text-animate');
    }

    function cleanValue(val) { return (val||'').trim().replace(/^"|"$/g,'').replace(/\r/g,''); }
    function parseDate(val) {
      var s = cleanValue(val);
      var m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (m) return m[3]+'-'+m[2]+'-'+m[1];
      return s;
    }
    function prettyPcType(raw) {
      if (!raw) return raw;
      var r = raw.toLowerCase();
      if (r==='standard') return 'Traditional Phillips Curve';
      if (r==='nk') return 'New Keynesian Phillips Curve';
      return raw.charAt(0).toUpperCase()+raw.slice(1);
    }
    function prettyEstimator(raw) {
      if (!raw) return raw;
      var r = raw.toLowerCase();
      if (r==='ols') return 'TV-OLS'; if (r==='iv') return 'TV-IV';
      return raw.toUpperCase();
    }
    function prettyCoef(raw) {
      var map = {'const':'Constant','(Intercept)':'Constant','dpi_lag1':'Lagged inflation','dpi_lead1':'Lead inflation','du':'Unemployment'};
      if (map[raw]) return map[raw];
      return raw ? raw.replace(/_/g,' ').replace(/\b\w/g,function(c){return c.toUpperCase();}) : raw;
    }
    function prettyKernel(raw) { if (!raw) return raw; return raw.charAt(0).toUpperCase()+raw.slice(1).toLowerCase(); }

    function startApp() {
      var region = document.getElementById('regionSelector').value;
      var isoCode = document.getElementById('countrySelector').value || REGION_DEFAULT[region];
      var fileKey = ISO_TO_FILE[isoCode];
      if (!fileKey) { alert('No data file found for: '+isoCode); return; }

      document.getElementById('appPillText').textContent = REGION_LABELS[region]+' \u00b7 '+(ISO_NAMES[isoCode]||isoCode);
      document.getElementById('app').classList.add('active');
      document.getElementById('landing-stage').style.display = 'none';
      document.getElementById('app-stage').style.display = 'flex';

      var af = document.getElementById('app-footer'); af.style.display = 'block';
      var afHr = document.getElementById('app-footer-hr'), afP = document.getElementById('app-footer-text');
      [afHr,afP].forEach(function(el){ el.classList.remove('footer-line-animate','footer-text-animate'); void el.offsetWidth; });
      afHr.classList.add('footer-line-animate'); afP.classList.add('footer-text-animate');
      requestAnimationFrame(function(){ requestAnimationFrame(syncSliderLength); });

      fetch('data/'+fileKey+'.csv')
        .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
        .then(function(text){
          fullData = parseCSV(text);
          if (!fullData.length) { alert('No data rows found.'); return; }
          setupControls(fullData); updatePlot();
          requestAnimationFrame(function(){ requestAnimationFrame(syncSliderLength); });
        }).catch(function(err){ alert('Error loading data: '+err.message); });
    }

    function parseCSV(text) {
      var lines = text.trim().split(/\r?\n/);
      if (lines.length < 2) return [];
      return lines.slice(1).map(function(line){
        if (!line.trim()) return null;
        var c = line.split(',');
        var coef = cleanValue(c[5]);
        if (coef === 'hausman') return null;
        var est = cleanValue(c[6]);
        if (est === '') return null;
        return { date:parseDate(c[0]), pc_type:cleanValue(c[1]), estimator:cleanValue(c[2]), kernel:cleanValue(c[3]), h1:cleanValue(c[4]), coef:coef, estimate:est, lower:cleanValue(c[7]), upper:cleanValue(c[8]) };
      }).filter(Boolean);
    }

    function setupControls(data) {
      function fillSelect(id,values,fn) {
        var sel = document.getElementById(id); sel.innerHTML = '';
        values.forEach(function(v){ var o=document.createElement('option'); o.value=v; o.textContent=fn?fn(v):v; sel.appendChild(o); });
      }
      var bwSet  = Array.from(new Set(data.map(function(d){return d.h1;}))).filter(function(v){return v!=='';});
      var kerSet = Array.from(new Set(data.map(function(d){return d.kernel;}))).filter(function(v){return v!=='';});
      var pcSet  = Array.from(new Set(data.map(function(d){return d.pc_type;}))).filter(function(v){return v!=='';});
      var estSet = Array.from(new Set(data.map(function(d){return d.estimator;}))).filter(function(v){return v!=='';});
      coefBySpec = {};
      data.forEach(function(d){ if(!coefBySpec[d.pc_type]) coefBySpec[d.pc_type]=new Set(); coefBySpec[d.pc_type].add(d.coef); });
      h1Values = bwSet.map(function(x){return parseFloat(x);}).filter(function(x){return !isNaN(x);}).sort(function(a,b){return a-b;});
      var slider = document.getElementById('bandwidthSlider');
      slider.min=0; slider.max=Math.max(h1Values.length-1,0); slider.step=1;
      var di = h1Values.findIndex(function(v){return Math.abs(v-0.5)<1e-8;});
      if(di===-1) di=Math.floor(h1Values.length/2);
      slider.value=di; updateBandwidthLabel(); slider.style.opacity=1;
      fillSelect('kernel',kerSet,prettyKernel); fillSelect('pcType',pcSet,prettyPcType); fillSelect('estimator',estSet,prettyEstimator);
      updateCoefOptions();
      slider.oninput=function(){ updateBandwidthLabel(); updatePlot(); };
      document.getElementById('kernel').onchange=updatePlot;
      document.getElementById('pcType').onchange=function(){ updateCoefOptions(); updatePlot(); };
      document.getElementById('estimator').onchange=updatePlot;
      document.getElementById('coef').onchange=updatePlot;
    }

    function updateCoefOptions() {
      var pcRaw=document.getElementById('pcType').value;
      var coefs=coefBySpec[pcRaw]?Array.from(coefBySpec[pcRaw]):[];
      var sel=document.getElementById('coef'); sel.innerHTML='';
      var order=['const','(Intercept)','dpi_lag1','dpi_lead1','du'];
      var ordered=order.filter(function(k){return coefs.includes(k);}).concat(coefs.filter(function(c){return !order.includes(c);}));
      ordered.forEach(function(v){ var o=document.createElement('option'); o.value=v; o.textContent=prettyCoef(v); sel.appendChild(o); });
      sel.value=coefs.includes('du')?'du':(ordered[0]||'');
    }

    function getCurrentH1() {
      var slider=document.getElementById('bandwidthSlider');
      var idx=Math.min(Math.max(parseInt(slider.value,10)||0,0),h1Values.length-1);
      return h1Values[idx];
    }
    function updateBandwidthLabel() { document.getElementById('bandwidthLabel').textContent='h = '+getCurrentH1().toFixed(1); }

    function updatePlot() {
      if(!fullData.length) return;
      var hNum=getCurrentH1(), kernel=document.getElementById('kernel').value;
      var pcRaw=document.getElementById('pcType').value, estRaw=document.getElementById('estimator').value;
      var coefRaw=document.getElementById('coef').value, tol=1e-8;
      var subset=fullData.filter(function(d){ return Math.abs(parseFloat(d.h1)-hNum)<tol && d.kernel===kernel && d.pc_type===pcRaw && d.estimator===estRaw && d.coef===coefRaw; });
      var plotDiv=document.getElementById('plot');
      if(!subset.length){ Plotly.newPlot(plotDiv,[],{paper_bgcolor:'#050712',plot_bgcolor:'#050712',xaxis:{visible:false},yaxis:{visible:false}}); return; }
      var dates=subset.map(function(d){return d.date;});
      var ests=subset.map(function(d){return parseFloat(d.estimate);});
      var lower=subset.map(function(d){return parseFloat(d.lower);});
      var upper=subset.map(function(d){return parseFloat(d.upper);});
      var yMin=Math.min.apply(null,lower), yMax=Math.max.apply(null,upper);
      var span=yMax-yMin, pad=span===0?0.1:span*0.08; yMin-=pad; yMax+=pad;
      var traces=[
        {x:dates.concat(dates.slice().reverse()),y:upper.concat(lower.slice().reverse()),fill:'toself',fillcolor:'rgba(49,225,255,0.12)',line:{color:'transparent'},name:'CI'},
        {x:dates,y:ests,mode:'lines',name:'',line:{width:2,color:'#31e1ff'}},
        {x:[dates[0]],y:[ests[0]],mode:'markers',marker:{size:8,color:'#31e1ff',line:{color:'#000000',width:1.5}},name:'hover-dot',hoverinfo:'skip',showlegend:false,opacity:0}
      ];
      var layout={showlegend:false,paper_bgcolor:'#050712',plot_bgcolor:'#050712',margin:{l:60,r:40,t:40,b:50},
        xaxis:{type:'date',tickformat:'%Y',hoverformat:'%b %Y',tickangle:0,showgrid:false,linecolor:'#3b3f55',nticks:7,range:[dates[0],dates[dates.length-1]],autorange:false,fixedrange:true},
        yaxis:{zeroline:true,zerolinecolor:'#303548',showgrid:false,linecolor:'#3b3f55',tickformat:'.2f',range:[yMin,yMax],autorange:false,fixedrange:true}
      };
      Plotly.newPlot(plotDiv,traces,layout,{responsive:true}).then(function(gd){
        gd.removeAllListeners('plotly_hover');
        gd.o
        gd.on('plotly_hover', function(ev) {
          var pt = ev.points.find(function(p) { return p.curveNumber === 1; });
          if (!pt) return;
          Plotly.restyle(gd, {x:[[pt.x]], y:[[pt.y]], opacity:[1]}, [2]);
        });
      });
    }
  </script>
</body>
</html>
