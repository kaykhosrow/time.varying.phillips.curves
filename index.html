<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Time-Varying Phillips Curves</title>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <!-- Dark, minimal styling -->
  <style>
    :root {
      --bg: #05060a;
      --card-bg: #111320;
      --card-bg-soft: #15182a;
      --accent: #31e1ff;
      --accent-soft: rgba(49, 225, 255, 0.18);
      --text-main: #f5f5f7;
      --text-subtle: #9ca3af;
      --border-subtle: #25273a;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      overflow: hidden;
      height: 100%;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #15192b 0, #05060a 55%);
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-width: 1000px;
    }

    .main-shell {
      width: min(1120px, 100% - 40px);
      margin: 40px auto;
      flex-shrink: 0;
      transform: scale(1.05);
      transform-origin: center center;
    }

    .card {
      background: linear-gradient(135deg, var(--card-bg) 0%, var(--card-bg-soft) 100%);
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
      padding: 24px 28px;
      backdrop-filter: blur(14px);
    }

    #landing {
      max-width: 820px;
      margin: 0 auto;
    }

    h1, h2 {
      margin: 0;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    h1 { font-size: 1.8rem; }
    h2 { font-size: 1.5rem; }

    p {
      margin: 8px 0;
      color: var(--text-subtle);
      line-height: 1.5;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px;
      border-radius: 999px;
      background: rgba(49, 225, 255, 0.09);
      border: 1px solid rgba(49, 225, 255, 0.18);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px 18px;
      margin-top: 24px;
      align-items: flex-end;
    }

    .app-controls-row {
      margin-top: 32px;
      flex-wrap: nowrap;
      justify-content: space-between;
    }

    .app-controls-row .control-group {
      flex: 1 1 0;
    }

    .app-controls-row .control-group select {
      width: 100%;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-start;
    }

    .control-label {
      font-size: 0.8rem;
      color: var(--text-subtle);
      margin-left: 5px;
    }

    .control-group select { width: 220px; }

    select {
      padding: 8px 10px;
      font-size: 0.9rem;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: #050712;
      color: var(--text-main);
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease,
                  background 0.2s ease, transform 0.05s ease;
    }

    select:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(49, 225, 255, 0.35);
      background: #070918;
    }

    button {
      padding: 8px 14px;
      font-size: 0.9rem;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: #050712;
      color: var(--text-main);
      outline: none;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease,
                  background 0.2s ease, transform 0.05s ease;
      white-space: nowrap;
      height: 36px;
    }

    button:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(49, 225, 255, 0.35);
      background: #070918;
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 0 0 1px rgba(49, 225, 255, 0.2);
    }

    .primary-btn {
      background: radial-gradient(circle at 0 0,
                    rgba(49, 225, 255, 0.28), transparent 55%),
                  linear-gradient(135deg, #0d90b8, #31e1ff);
      border: none;
      color: #05060a;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
    }

    .primary-btn:hover {
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.75);
      transform: translateY(-1px);
      border: none;
      background: radial-gradient(circle at 0 0,
                    rgba(49, 225, 255, 0.35), transparent 55%),
                  linear-gradient(135deg, #10a4cf, #4ae5ff);
    }

    .primary-btn:active {
      transform: translateY(1px);
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.7);
    }

    .landing-region-group {
      flex-direction: row;
      align-items: center;
      gap: 10px;
    }

    .landing-region-group .control-label { margin: 0; }

    #landing .controls-row {
      align-items: center;
      justify-content: space-between;
    }

    .pill-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(49, 225, 255, 0.09);
      border: 1px solid rgba(49, 225, 255, 0.18);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent);
      height: auto;
      box-shadow: none;
      width: 80px;
    }

    .pill-button:hover {
      background: rgba(49, 225, 255, 0.14);
      border-color: rgba(49, 225, 255, 0.28);
      color: var(--accent);
      transform: none;
      box-shadow: 0 0 12px rgba(49, 225, 255, 0.25);
    }

    #landing, #app {
      display: none;
      animation: fadeIn 0.4s ease-out;
    }

    #landing.active, #app.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 12px;
    }

    .app-header-right {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
    }

    .plot-shell {
      margin-top: 18px;
      display: flex;
      gap: 18px;
      align-items: stretch;
    }

    #plot {
      flex: 1 1 auto;
      min-height: 520px;
      border-radius: 14px;
      background: #050712;
      padding: 6px 18px 6px 6px;
      overflow: hidden;
    }

    .slider-shell {
      width: 110px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .slider-column {
      width: 100%;
      flex: 1 1 auto;
      border-radius: 14px;
      background: radial-gradient(circle at top,
                  rgba(49,225,255,0.1), transparent 55%);
      border: 1px solid var(--border-subtle);
      padding: 10px 4px 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slider-wrapper {
      width: 100%;
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
      position: relative;
    }

    #bandwidthSlider {
      -webkit-appearance: none;
      appearance: none;
      width: 200px;        /* sensible CSS default; JS will override */
      height: 6px;
      background: #0b0e1b;
      border-radius: 999px;
      outline: none;
      transform: rotate(-90deg);
      cursor: pointer;
      position: absolute;
      flex-shrink: 0;
    }

    #bandwidthSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(49, 225, 255, 0.8);
      border: 1px solid #02141b;
    }

    #bandwidthSlider::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
    }

    #bandwidthSlider::-webkit-slider-runnable-track { border-radius: 999px; }

    #bandwidthSlider::-moz-range-track {
      border-radius: 999px;
      background: #0b0e1b;
      height: 6px;
    }

    .slider-value-pill {
      font-size: 0.75rem;
      font-variant-numeric: tabular-nums;
      padding: 4px 12px;
      border-radius: 999px;
      background: radial-gradient(circle at 0 0,
                    rgba(49, 225, 255, 0.25), transparent 60%),
                  linear-gradient(135deg, #0d90b8, #31e1ff);
      color: #05060a;
      border: none;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
      width: 110px;
      text-align: center;
    }

  </style>
</head>

<body>
  <div class="main-shell">
    <!-- LANDING VIEW -->
    <div id="landing" class="card active">
      <h1>Time-Varying Phillips Curves</h1>
      <p>Browse kernel-based estimates of the Phillips curve over time.</p>

      <div class="controls-row">
        <div class="control-group landing-region-group">
          <label for="regionSelector" class="control-label">Region:</label>
          <select id="regionSelector">
            <option value="euro-area">Euro Area</option>
          </select>
        </div>
        <button type="button" class="primary-btn" onclick="startApp()">Enter</button>
      </div>
    </div>

    <!-- APP VIEW -->
    <div id="app" class="card">
      <div class="app-header">
        <h2>Time-Varying Parameters of the Phillips Curve</h2>
        <div class="app-header-right">
          <div class="pill">
            <span class="pill-dot"></span>
            <span>Euro Area · Time-Varying Estimates</span>
          </div>
          <button type="button" class="pill-button" onclick="goBack()">← Back</button>
        </div>
      </div>

      <div class="controls-row app-controls-row">
        <div class="control-group">
          <label class="control-label" for="pcType">Specification:</label>
          <select id="pcType"></select>
        </div>
        <div class="control-group">
          <label class="control-label" for="estimator">Estimator:</label>
          <select id="estimator"></select>
        </div>
        <div class="control-group">
          <label class="control-label" for="kernel">Kernel:</label>
          <select id="kernel"></select>
        </div>
        <div class="control-group">
          <label class="control-label" for="coef">Coefficient:</label>
          <select id="coef"></select>
        </div>
      </div>

      <div class="plot-shell">
        <div id="plot"></div>

        <div class="slider-shell">
          <div class="slider-column">
            <div class="slider-wrapper">
              <input type="range" id="bandwidthSlider" min="0" max="0" step="1" value="0">
            </div>
          </div>
          <div class="slider-value-pill" id="bandwidthLabel">h = 0.5</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // resize slider once layout is known
    function syncSliderLength() {
      const col    = document.querySelector('.slider-column');
      const slider = document.getElementById('bandwidthSlider');
      if (!col || !slider) return;
      const h = col.clientHeight;
      if (h > 0) {
        slider.style.width = Math.round(h * 0.78) + 'px';
      }
    }

    window.addEventListener('resize', syncSliderLength);

    // region → CSV file mapping
    const REGION_FILES = {
      "euro-area": "data/euro_area_tvpc_full.csv"
    };

    let fullData   = [];
    let h1Values   = [];
    let coefBySpec = {};

    function goBack() {
      document.getElementById("app").classList.remove("active");
      document.getElementById("landing").classList.add("active");
    }

    function cleanValue(val) {
      return (val || "").trim().replace(/^"|"$/g, "");
    }

    function prettyPcType(raw) {
      if (!raw) return raw;
      const r = raw.toLowerCase();
      if (r === "standard") return "Standard Phillips Curve";
      if (r === "nk")       return "New Keynesian Phillips Curve";
      return raw.charAt(0).toUpperCase() + raw.slice(1);
    }

    function prettyEstimator(raw) {
      if (!raw) return raw;
      const r = raw.toLowerCase();
      if (r === "ols") return "TV-OLS";
      if (r === "iv")  return "TV-IV";
      return raw.toUpperCase();
    }

    function prettyCoef(raw) {
      const map = {
        "(Intercept)": "Constant",
        "dpi_lag1":    "Lagged inflation",
        "dpi_lead1":   "Lead inflation",
        "du":          "Unemployment"
      };
      if (map[raw]) return map[raw];
      return raw
        ? raw.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase())
        : raw;
    }

    function prettyKernel(raw) {
      if (!raw) return raw;
      const r = raw.toLowerCase();
      return r.charAt(0).toUpperCase() + r.slice(1);
    }

    function startApp() {
      const region = document.getElementById("regionSelector").value;
      const file   = REGION_FILES[region];

      document.getElementById("landing").classList.remove("active");
      document.getElementById("app").classList.add("active");

      // Wait two frames for layout to settle, then size the slider
      requestAnimationFrame(() => requestAnimationFrame(syncSliderLength));

      fetch(file)
        .then(r => {
          if (!r.ok) throw new Error("HTTP " + r.status);
          return r.text();
        })
        .then(text => {
          fullData = parseCSV(text);
          if (fullData.length === 0) {
            alert("No data rows found or headers not recognised.");
            return;
          }
          setupControls(fullData);
          updatePlot();
          requestAnimationFrame(() => requestAnimationFrame(syncSliderLength));
        })
        .catch(err => {
          console.error(err);
          alert("Error loading data: " + err.message);
        });
    }

    // --- header-based parser (robust to column order & h vs h1, etc.) ---
    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length < 2) return [];

      const headers = lines[0].split(",").map(cleanValue);

      function idx(nameCandidates) {
        for (const cand of nameCandidates) {
          const i = headers.findIndex(
            h => h.toLowerCase() === cand.toLowerCase()
          );
          if (i !== -1) return i;
        }
        return -1;
      }

      const idxDate      = idx(["date"]);
      const idxH1        = idx(["h1", "h"]);
      const idxKernel    = idx(["kernel", "kern"]);
      const idxPcType    = idx(["pc_type", "spec", "pc"]);
      const idxEstimator = idx(["estimator", "est"]);
      const idxCoef      = idx(["coef", "coefficient"]);
      const idxEst       = idx(["estimate", "beta", "b"]);
      const idxLower     = idx(["lower", "ci_lower", "lwr"]);
      const idxUpper     = idx(["upper", "ci_upper", "upr"]);

      if (
        idxDate === -1 || idxH1 === -1 || idxKernel === -1 ||
        idxPcType === -1 || idxEstimator === -1 || idxCoef === -1 ||
        idxEst === -1 || idxLower === -1 || idxUpper === -1
      ) {
        console.error("parseCSV: could not find all required headers", headers);
        return [];
      }

      return lines.slice(1)
        .map(line => {
          if (!line.trim()) return null;
          const c = line.split(",");

          const row = {
            date:      cleanValue(c[idxDate]),
            h1:        cleanValue(c[idxH1]),
            kernel:    cleanValue(c[idxKernel]),
            pc_type:   cleanValue(c[idxPcType]),
            estimator: cleanValue(c[idxEstimator]),
            coef:      cleanValue(c[idxCoef]),
            estimate:  cleanValue(c[idxEst]),
            lower:     cleanValue(c[idxLower]),
            upper:     cleanValue(c[idxUpper])
          };

          if (!row.date || row.estimate === "") return null;
          return row;
        })
        .filter(Boolean);
    }

    function setupControls(data) {
      function fillSelect(id, values, fn) {
        const sel = document.getElementById(id);
        sel.innerHTML = "";
        values.forEach(v => {
          const o = document.createElement("option");
          o.value = v;
          o.textContent = fn ? fn(v) : v;
          sel.appendChild(o);
        });
      }

      const bwSet  = [...new Set(data.map(d => d.h1))].filter(Boolean);
      const kerSet = [...new Set(data.map(d => d.kernel))].filter(Boolean);
      const pcSet  = [...new Set(data.map(d => d.pc_type))].filter(Boolean);
      const estSet = [...new Set(data.map(d => d.estimator))].filter(Boolean);

      coefBySpec = {};
      data.forEach(d => {
        if (!coefBySpec[d.pc_type]) coefBySpec[d.pc_type] = new Set();
        coefBySpec[d.pc_type].add(d.coef);
      });

      h1Values = bwSet
        .map(x => parseFloat(x))
        .filter(x => !isNaN(x))
        .sort((a, b) => a - b);

      const slider = document.getElementById("bandwidthSlider");
      slider.min   = 0;
      slider.max   = Math.max(h1Values.length - 1, 0);
      slider.step  = 1;
      slider.value = Math.floor(h1Values.length / 2);
      updateBandwidthLabel();

      fillSelect("kernel",    kerSet,  prettyKernel);
      fillSelect("pcType",    pcSet,   prettyPcType);
      fillSelect("estimator", estSet,  prettyEstimator);
      updateCoefOptions();

      slider.oninput = () => { updateBandwidthLabel(); updatePlot(); };
      document.getElementById("kernel").onchange    = updatePlot;
      document.getElementById("pcType").onchange    = () => { updateCoefOptions(); updatePlot(); };
      document.getElementById("estimator").onchange = updatePlot;
      document.getElementById("coef").onchange      = updatePlot;
    }

    function updateCoefOptions() {
      const pcRaw = document.getElementById("pcType").value;
      const coefs = coefBySpec[pcRaw] ? [...coefBySpec[pcRaw]] : [];
      const sel   = document.getElementById("coef");
      sel.innerHTML = "";

      // Prefer to show: Constant, inflation terms, Unemployment
      const order = ["(Intercept)", "dpi_lag1", "dpi_lead1", "du"];
      const ordered = [
        ...order.filter(k => coefs.includes(k)),
        ...coefs.filter(c => !order.includes(c))
      ];

      ordered.forEach(v => {
        const o = document.createElement("option");
        o.value = v;
        o.textContent = prettyCoef(v);
        sel.appendChild(o);
      });

      const hasDu = coefs.includes("du");
      sel.value = hasDu ? "du" : (ordered[0] || "");
    }

    function getCurrentH1Numeric() {
      const slider = document.getElementById("bandwidthSlider");
      const idx = Math.min(
        Math.max(parseInt(slider.value, 10) || 0, 0),
        h1Values.length - 1
      );
      return h1Values[idx];
    }

    function updateBandwidthLabel() {
      const h = getCurrentH1Numeric();
      document.getElementById("bandwidthLabel").textContent = "h = " + h.toFixed(1);
    }

    function updatePlot() {
      if (!fullData.length) return;

      const hNum       = getCurrentH1Numeric();
      const kernelSel  = document.getElementById("kernel").value;
      const pcSel      = document.getElementById("pcType").value;
      const estSel     = document.getElementById("estimator").value;
      const coefSel    = document.getElementById("coef").value;

      const kernelRaw  = (kernelSel || "").toLowerCase();
      const pcRaw      = (pcSel || "").toLowerCase();
      const estRaw     = (estSel || "").toLowerCase();
      const coefRaw    = coefSel;

      const tol = 1e-8;

      const subset = fullData.filter(d => {
        const hVal = parseFloat(d.h1);
        const ker  = (d.kernel    || "").toLowerCase().trim();
        const pc   = (d.pc_type   || "").toLowerCase().trim();
        const est  = (d.estimator || "").toLowerCase().trim();
        const cf   = d.coef;
        return !isNaN(hVal) &&
               Math.abs(hVal - hNum) < tol &&
               ker === kernelRaw &&
               pc  === pcRaw &&
               est === estRaw &&
               cf  === coefRaw;
      });

      if (subset.length === 0) {
        console.warn("No subset match for current filters", {
          h: hNum,
          kernelRaw,
          pcRaw,
          estRaw,
          coefRaw,
          uniqueKernels: [...new Set(fullData.map(d => d.kernel))],
          uniquePc:      [...new Set(fullData.map(d => d.pc_type))],
          uniqueEst:     [...new Set(fullData.map(d => d.estimator))]
        });

        Plotly.newPlot("plot", [], {
          paper_bgcolor: "#050712",
          plot_bgcolor: "#050712",
          xaxis: { visible: false },
          yaxis: { visible: false }
        });
        return;
      }

      const dates = subset.map(d => d.date);
      const ests  = subset.map(d => parseFloat(d.estimate));
      const lower = subset.map(d => parseFloat(d.lower));
      const upper = subset.map(d => parseFloat(d.upper));

      Plotly.newPlot("plot", [
        {
          x: [...dates, ...dates.slice().reverse()],
          y: [...upper, ...lower.slice().reverse()],
          fill: "toself",
          fillcolor: "rgba(49,225,255,0.12)",
          line: { color: "transparent" },
          name: "CI"
        },
        {
          x: dates,
          y: ests,
          mode: "lines",
          name: "Estimate",
          line: { width: 2, color: "#31e1ff" }
        }
      ], {
        showlegend: false,
        paper_bgcolor: "#050712",
        plot_bgcolor: "#050712",
        margin: { l: 60, r: 40, t: 20, b: 50 },
        xaxis: {
          type: "date",
          tickformat: "%Y",
          hoverformat: "%b %Y",
          tickangle: 0,
          showgrid: false,
          linecolor: "#3b3f55",
          nticks: 7
        },
        yaxis: {
          zeroline: true,
          zerolinecolor: "#303548",
          showgrid: false,
          linecolor: "#3b3f55",
          tickformat: ".2f"
        }
      }, { responsive: true });
    }
  </script>
</body>
</html>
