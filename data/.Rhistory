du       = df$du
)
Z_standard <- cbind(
const   = 1,
dpi_lag1 = df$dpi_lag1,
du_l1    = df$du_l1,
du_l2    = df$du_l2,
du_l3    = df$du_l3,
du_l4    = df$du_l4,
dpi_l2   = df$dpi_l2
)
colnames(X_standard) <- c("const", "dpi_lag1", "du")
colnames(Z_standard) <- c("const", "dpi_lag1",
"du_l1", "du_l2", "du_l3", "du_l4",
"dpi_l2")
## TV-OLS
ols_standard <- tv_OLS_tv(
y  = y,
X  = X_standard,
h1 = H1_STANDARD
)
## TV-IV (Δu endogenous = column 3)
iv_standard <- tv_IV_tv(
y_vec     = y,
COVAR     = X_standard,
INST      = Z_standard,
endog_idx = 3L,
h1        = H1_STANDARD,
h2        = H2_STANDARD
)
## --- NK PC: Δπ_t ~ Δπ_{t+1} + Δπ_{t-1} + Δu_t ------------
X_nk <- cbind(
const     = 1,
dpi_lead1 = df$dpi_lead1,
dpi_lag1  = df$dpi_lag1,
du        = df$du
)
Z_nk <- cbind(
const   = 1,
dpi_lag1 = df$dpi_lag1,
dpi_l2   = df$dpi_l2,
dpi_l3   = df$dpi_l3,
dpi_l4   = df$dpi_l4,
du_l1    = df$du_l1,
du_l2    = df$du_l2,
du_l3    = df$du_l3,
du_l4    = df$du_l4
)
colnames(X_nk) <- c("const", "dpi_lead1", "dpi_lag1", "du")
colnames(Z_nk) <- c("const", "dpi_lag1",
"dpi_l2", "dpi_l3", "dpi_l4",
"du_l1", "du_l2", "du_l3", "du_l4")
## TV-OLS
ols_nk <- tv_OLS_tv(
y  = y,
X  = X_nk,
h1 = H1_NK
)
## TV-IV
## If in my Gretl run ONLY Δu was endogenous, I would set endog_idx_nk <- 4L
endog_idx_nk <- c(2L, 4L)  # dpi_lead1 and du
iv_nk <- tv_IV_tv(
y_vec     = y,
COVAR     = X_nk,
INST      = Z_nk,
endog_idx = endog_idx_nk,
h1        = H1_NK,
h2        = H2_NK
)
############################################################
## 8. BUILD OLS & IV COEFFICIENT DATA FRAMES + CIs
############################################################
build_ci_df <- function(beta_mat, se_mat, dates, model_label, coef_names) {
beta <- as.matrix(beta_mat)
se   <- as.matrix(se_mat)
colnames(beta) <- coef_names
colnames(se)   <- coef_names
df_beta <- as.data.frame(beta)
df_se   <- as.data.frame(se)
df_beta$date <- dates
df_se$date   <- dates
df_long <- df_beta %>%
tidyr::pivot_longer(
cols      = -date,
names_to  = "coef",
values_to = "estimate"
)
df_se_long <- df_se %>%
tidyr::pivot_longer(
cols      = -date,
names_to  = "coef",
values_to = "se"
)
df_full <- df_long %>%
dplyr::left_join(df_se_long, by = c("date", "coef")) %>%
dplyr::mutate(
lower = estimate - Z_CRIT * se,
upper = estimate + Z_CRIT * se,
model = model_label
)
df_full
}
coef_names_standard <- c("(Intercept)", "dpi_lag1", "du")
coef_names_nk       <- c("(Intercept)", "dpi_lead1", "dpi_lag1", "du")
## Map my columns to nice names
## (Intercept) == const here
colnames(ols_standard$coeff)  <- coef_names_standard
colnames(ols_standard$stderr) <- coef_names_standard
colnames(ols_nk$coeff)  <- coef_names_nk
colnames(ols_nk$stderr) <- coef_names_nk
colnames(iv_standard$coeff_iv)  <- coef_names_standard
colnames(iv_standard$stderr_iv) <- coef_names_standard
colnames(iv_nk$coeff_iv)  <- coef_names_nk
colnames(iv_nk$stderr_iv) <- coef_names_nk
## OLS CI data frames
df_ols_standard_ci <- build_ci_df(
beta_mat    = ols_standard$coeff,
se_mat      = ols_standard$stderr,
dates       = df$date,
model_label = "Standard PC – TV-OLS",
coef_names  = coef_names_standard
)
df_ols_nk_ci <- build_ci_df(
beta_mat    = ols_nk$coeff,
se_mat      = ols_nk$stderr,
dates       = df$date,
model_label = "NK PC – TV-OLS",
coef_names  = coef_names_nk
)
## IV CI data frames
df_iv_standard_ci <- build_ci_df(
beta_mat    = iv_standard$coeff_iv,
se_mat      = iv_standard$stderr_iv,
dates       = df$date,
model_label = "Standard PC – TV-IV",
coef_names  = coef_names_standard
)
df_iv_nk_ci <- build_ci_df(
beta_mat    = iv_nk$coeff_iv,
se_mat      = iv_nk$stderr_iv,
dates       = df$date,
model_label = "NK PC – TV-IV",
coef_names  = coef_names_nk
)
############################################################
## 9. HAUSMAN p-VALUE DATA FRAMES
############################################################
df_hausman_standard <- data.frame(
date   = df$date,
H_stat = iv_standard$H_stat,
p_val  = iv_standard$p_val
)
df_hausman_nk <- data.frame(
date   = df$date,
H_stat = iv_nk$H_stat,
p_val  = iv_nk$p_val
)
############################################################
## 10. PLOTTING FUNCTIONS
############################################################
pc_plot_ci <- function(df_ci, pc_type = c("standard", "nk"),
subtitle_text = "",
fill_col = "#79c2e6",
line_col = "#ee342a") {
pc_type <- match.arg(pc_type)
if (pc_type == "standard") {
df_plot <- df_ci %>%
dplyr::mutate(
coef_pretty = dplyr::recode(
coef,
"(Intercept)" = "beta[0](t)",
"dpi_lag1"    = "gamma(t)",
"du"          = "alpha(t)",
.default      = coef
),
coef_pretty = factor(
coef_pretty,
levels = c("beta[0](t)", "gamma(t)", "alpha(t)")
)
)
title_expr <- expression(Delta * pi[t] ==
beta[0](t) +
gamma(t) * Delta * pi[t - 1] +
alpha(t) * Delta * u[t])
} else {
df_plot <- df_ci %>%
dplyr::mutate(
coef_pretty = dplyr::recode(
coef,
"(Intercept)" = "beta[0](t)",
"dpi_lag1"    = "gamma(t)",
"du"          = "alpha(t)",
"dpi_lead1"   = "rho(t)",
.default      = coef
),
coef_pretty = factor(
coef_pretty,
levels = c("beta[0](t)", "rho(t)", "gamma(t)", "alpha(t)")
)
)
title_expr <- expression(Delta * pi[t] ==
beta[0](t) +
rho(t)   * Delta * pi[t + 1] +
gamma(t) * Delta * pi[t - 1] +
alpha(t) * Delta * u[t])
}
ggplot(df_plot,
aes(x = date, y = estimate)) +
geom_ribbon(aes(ymin = lower, ymax = upper),
fill = fill_col, alpha = 0.35, colour = NA) +
geom_line(colour = line_col, linewidth = 1, alpha = 0.875) +
facet_wrap(~ coef_pretty,
scales   = "free_y",
ncol     = 1,
labeller = label_parsed) +
labs(title = title_expr,
subtitle = subtitle_text) +
scale_x_date(date_breaks = "5 years",
date_labels = "%Y",
expand      = c(0, 0)) +
scale_y_continuous(labels = function(x) format(x, nsmall = 2)) +
theme(
axis.ticks.length = unit(-0.15, "cm"),
panel.grid.major  = element_blank(),
panel.grid.minor  = element_blank(),
axis.text         = element_text(family = "Times New Roman"),
plot.title        = element_text(
hjust  = 0.5,
family = "Times New Roman",
face   = "bold",
margin = margin(b = 5),
colour = "black"
),
plot.subtitle     = element_text(
hjust  = 0.5,
family = "Times New Roman",
margin = margin(b = 5)
),
axis.title.x      = element_blank(),
axis.title.y      = element_blank(),
panel.background  = element_blank(),
panel.border      = element_rect(colour = "black", fill = NA),
plot.margin       = unit(c(0.5, 0.5, 0.5, 0.5), "lines"),
strip.background  = element_blank(),
strip.text        = element_text(
family = "Times New Roman",
face   = "bold"
)
)
}
## Combined TV-OLS vs TV-IV coefficient paths (point estimates only)
pc_plot_combined <- function(df_ols_ci, df_iv_ci,
pc_type = c("standard", "nk"),
subtitle_text = "") {
pc_type <- match.arg(pc_type)
df_ols <- df_ols_ci %>%
dplyr::select(date, coef, estimate) %>%
dplyr::mutate(estimator = "TV-OLS")
df_iv <- df_iv_ci %>%
dplyr::select(date, coef, estimate) %>%
dplyr::mutate(estimator = "TV-IV")
df_both <- dplyr::bind_rows(df_ols, df_iv)
if (pc_type == "standard") {
df_plot <- df_both %>%
dplyr::mutate(
coef_pretty = dplyr::recode(
coef,
"(Intercept)" = "beta[0](t)",
"dpi_lag1"    = "gamma(t)",
"du"          = "alpha(t)",
.default      = coef
),
coef_pretty = factor(
coef_pretty,
levels = c("beta[0](t)", "gamma(t)", "alpha(t)")
)
)
title_expr <- expression(Delta * pi[t] ==
beta[0](t) +
gamma(t) * Delta * pi[t - 1] +
alpha(t) * Delta * u[t])
} else {
df_plot <- df_both %>%
dplyr::mutate(
coef_pretty = dplyr::recode(
coef,
"(Intercept)" = "beta[0](t)",
"dpi_lag1"    = "gamma(t)",
"du"          = "alpha(t)",
"dpi_lead1"   = "rho(t)",
.default      = coef
),
coef_pretty = factor(
coef_pretty,
levels = c("beta[0](t)", "rho(t)", "gamma(t)", "alpha(t)")
)
)
title_expr <- expression(Delta * pi[t] ==
beta[0](t) +
rho(t)   * Delta * pi[t + 1] +
gamma(t) * Delta * pi[t - 1] +
alpha(t) * Delta * u[t])
}
ggplot(df_plot,
aes(x = date, y = estimate, colour = estimator)) +
geom_line(linewidth = 1, alpha = 0.9) +
facet_wrap(~ coef_pretty,
scales   = "free_y",
ncol     = 1,
labeller = label_parsed) +
labs(title = title_expr,
subtitle = subtitle_text,
colour = NULL) +
scale_x_date(date_breaks = "5 years",
date_labels = "%Y",
expand      = c(0, 0)) +
scale_y_continuous(labels = function(x) format(x, nsmall = 2)) +
scale_colour_manual(values = c("TV-OLS" = "#ee342a", "TV-IV" = "darkgreen")) +
theme(
axis.ticks.length = unit(-0.15, "cm"),
panel.grid.major  = element_blank(),
panel.grid.minor  = element_blank(),
axis.text         = element_text(family = "Times New Roman"),
plot.title        = element_text(
hjust  = 0.5,
family = "Times New Roman",
face   = "bold",
margin = margin(b = 5),
colour = "black"
),
plot.subtitle     = element_text(
hjust  = 0.5,
family = "Times New Roman",
margin = margin(b = 5)
),
axis.title.x      = element_blank(),
axis.title.y      = element_blank(),
panel.background  = element_blank(),
panel.border      = element_rect(colour = "black", fill = NA),
plot.margin       = unit(c(0.5, 0.5, 0.5, 0.5), "lines"),
strip.background  = element_blank(),
strip.text        = element_text(
family = "Times New Roman",
face   = "bold"
),
legend.position   = "bottom"
)
}
## TV Hausman p-values
hausman_p_plot <- function(df_H,
title_text,
h1_used,
y_label = "p-value") {
ggplot(df_H, aes(x = date, y = p_val)) +
geom_line(colour = "firebrick4", linewidth = 1, alpha = 0.9) +
geom_hline(yintercept = c(0.10, 0.05, 0.01),
linetype   = "dashed",
colour     = "grey40",
linewidth  = 0.5) +
scale_x_date(date_breaks = "5 years",
date_labels = "%Y",
expand      = c(0, 0)) +
scale_y_continuous(
limits = c(0, 1),
breaks = seq(0, 1, by = 0.1),
labels = function(x) sprintf("%.1f", x)
) +
labs(
title    = title_text,
subtitle = sprintf("TV Hausman test, h = %.2f", h1_used),
y        = y_label,
x        = NULL
) +
theme(
axis.ticks.length = unit(-0.15, "cm"),
panel.grid.major  = element_blank(),
panel.grid.minor  = element_blank(),
axis.text         = element_text(family = "Times New Roman"),
plot.title        = element_text(
hjust  = 0.5,
family = "Times New Roman",
face   = "bold",
margin = margin(b = 5),
colour = "black"
),
plot.subtitle     = element_text(
hjust  = 0.5,
family = "Times New Roman",
margin = margin(b = 5)
),
axis.title.x      = element_blank(),
axis.title.y      = element_text(
family = "Times New Roman",
margin = margin(r = 5)
),
panel.background  = element_blank(),
panel.border      = element_rect(colour = "black", fill = NA),
plot.margin       = unit(c(0.5, 0.5, 0.5, 0.5), "lines"),
strip.background  = element_blank(),
strip.text        = element_text(
family = "Times New Roman",
face   = "bold"
)
)
}
############################################################
## 11. PRODUCE PLOTS
############################################################
## OLS CI plots
plot_ols_standard <- pc_plot_ci(
df_ols_standard_ci,
pc_type       = "standard",
subtitle_text = sprintf("Euro Area – TV-OLS, h = %.2f, CI = %.2f",
H1_STANDARD, CI_LEVEL),
fill_col      = "#79c2e6",
line_col      = "#ee342a"
)
plot_ols_nk <- pc_plot_ci(
df_ols_nk_ci,
pc_type       = "nk",
subtitle_text = sprintf("Euro Area – TV-OLS, h = %.2f, CI = %.2f",
H1_NK, CI_LEVEL),
fill_col      = "#79c2e6",
line_col      = "#ee342a"
)
## IV CI plots
plot_iv_standard <- pc_plot_ci(
df_iv_standard_ci,
pc_type       = "standard",
subtitle_text = sprintf("Euro Area – TV-IV, h = %.2f, CI = %.2f",
H1_STANDARD, CI_LEVEL),
fill_col      = "darkseagreen2",
line_col      = "darkgreen"
)
plot_iv_nk <- pc_plot_ci(
df_iv_nk_ci,
pc_type       = "nk",
subtitle_text = sprintf("Euro Area – TV-IV, h = %.2f, CI = %.2f",
H1_NK, CI_LEVEL),
fill_col      = "darkseagreen2",
line_col      = "darkgreen"
)
## Combined TV-OLS vs TV-IV coefficient paths
plot_combined_standard <- pc_plot_combined(
df_ols_standard_ci,
df_iv_standard_ci,
pc_type       = "standard",
subtitle_text = sprintf("Euro Area – Standard PC, TV-OLS vs TV-IV, h = %.2f",
H1_STANDARD)
)
plot_combined_nk <- pc_plot_combined(
df_ols_nk_ci,
df_iv_nk_ci,
pc_type       = "nk",
subtitle_text = sprintf("Euro Area – New Keynesian PC, TV-OLS vs TV-IV, h = %.2f",
H1_NK)
)
## Hausman p-value plots
plot_hausman_standard <- hausman_p_plot(
df_hausman_standard,
title_text = "Euro Area – Standard Phillips Curve\nTV Hausman p-values",
h1_used    = H1_STANDARD
)
plot_hausman_nk <- hausman_p_plot(
df_hausman_nk,
title_text = "Euro Area – New Keynesian Phillips Curve\nTV Hausman p-values",
h1_used    = H1_NK
)
## Print plots
print(plot_ols_standard)
print(plot_ols_nk)
print(plot_iv_standard)
print(plot_iv_nk)
print(plot_combined_standard)
print(plot_combined_nk)
print(plot_hausman_standard)
print(plot_hausman_nk)
############################################################
## 12. EXPORT DATA FOR REPLICATION
############################################################
## Build a clean data frame for replication
## (df already has NAs removed, so this matches the estimation sample)
df_input <- df %>%
dplyr::transmute(
date      = format(date, "%Y-%m-%d"),
U         = U,
CPI       = CPI,
pi        = pi,
dpi       = dpi,
dpi_lag1  = dpi_lag1,
dpi_lead1 = dpi_lead1,
dpi_l2    = dpi_l2,
dpi_l3    = dpi_l3,
dpi_l4    = dpi_l4,
du        = du,
du_l1     = du_l1,
du_l2     = du_l2,
du_l3     = du_l3,
du_l4     = du_l4
)
## Write to CSV
write.csv(df_input, "tvpc_input_data.csv", row.names = FALSE)
cat("Exported data to 'tvpc_input_data.csv'\n")
## Print plots
print(plot_ols_standard)
print(plot_ols_nk)
print(plot_iv_standard)
print(plot_iv_nk)
print(plot_combined_standard)
print(plot_combined_nk)
print(plot_hausman_standard)
print(plot_hausman_nk)
